# Stage-3 self-training: EMA teacher-student on Cityscapes
# Uses best stage-2 checkpoint (PQ=24.68 at step 6500)
#
# CUPS self-training: 3 rounds × 500 steps = 1500 total steps
# Teacher (EMA momentum=0.999) generates pseudo-labels on-the-fly
# Student fine-tunes heads only (backbone + BN frozen)
# LR = 0.00001 (10× smaller than stage-2)
#
# Memory note: Teacher + Student in memory simultaneously, plus TTA
# (3 scales). Batch_size=4 with accumulate=4 → effective batch=16.
# Adjust BATCH_SIZE down if OOM on GTX 1080 Ti.
#
# IMPORTANT: Requires leftImg8bit_sequence/ in Cityscapes root.
# If you only have leftImg8bit/, create a symlink:
#   cd datasets/cityscapes && ln -s leftImg8bit leftImg8bit_sequence
#
# Usage:
#   python refs/cups/train_self.py \
#       --experiment_config_file refs/cups/configs/train_self_cityscapes_resnet50_k100.yaml \
#       --disable_wandb
DATA:
  CROP_RESOLUTION: (640, 1280)
  SCALE: 0.625
  DATASET: "cityscapes"
  ROOT: "datasets/cityscapes/"
  ROOT_VAL: "datasets/cityscapes/"
MODEL:
  BACKBONE_TYPE: "resnet50"
  USE_DINO: True
  # Best stage-2 checkpoint (step 6500, PQ=24.68)
  CHECKPOINT: "experiments/experiments/cups_resnet50_k100_stage2/Unsupervised Panoptic Segmentation/yy7k1h9d/checkpoints/ups_checkpoint_step=006500.ckpt"
  INFERENCE_CONFIDENCE_THRESHOLD: 0.5
  TTA_INFERENCE_CONFIDENCE_THRESHOLD: 0.7
  TTA_SCALES: [0.5, 0.75, 1.0]
TRAINING:
  # Reduced batch for teacher+student in memory on 2× GTX 1080 Ti
  BATCH_SIZE: 4
  PRECISION: "16-mixed"
  OPTIMIZER: "adamw"
  ADAMW:
    LEARNING_RATE: 0.00001
    WEIGHT_DECAY: 0.00001
  VAL_EVERY_N_STEPS: 50
  # Effective batch = 4 × 4 = 16 (matches CUPS default)
  ACCUMULATE_GRAD_BATCHES: 4
  DROP_LOSS: False
SELF_TRAINING:
  ROUND_STEPS: 500
  ROUNDS: 3
  USE_DROP_LOSS: False
  SEMANTIC_SEGMENTATION_THRESHOLD: 0.5
  CONFIDENCE_STEP: 0.05
AUGMENTATION:
  COPY_PASTE: True
  MAX_NUM_PASTED_OBJECTS: 8
  NUM_STEPS_STARTUP: 0
  RESOLUTIONS:
    - [384, 768]
    - [416, 832]
    - [448, 896]
    - [480, 960]
    - [512, 1024]
    - [544, 1088]
    - [576, 1152]
    - [640, 1280]
    - [672, 1344]
    - [704, 1408]
SYSTEM:
  ACCELERATOR: "gpu"
  NUM_GPUS: 1
  NUM_WORKERS: 4
  LOG_PATH: "experiments"
  RUN_NAME: "cups_resnet50_k100_stage3_self"
VALIDATION:
  CACHE_DEVICE: "cpu"
