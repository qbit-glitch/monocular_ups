# Stage-2 training: DINO ResNet-50 + Cascade Mask R-CNN
# Pseudo-labels: k=100 overclustered CAUSE semantics + SPIdepth depth-guided instances
# Best stage-1 config: gt=0.20, ma=1000 → PQ=27.10 (19-class eval)
#
# CUPS paper: batch_size=16 (default), 4000 steps, AdamW
#
# Key fixes (v4 — reverted IGNORE_UNKNOWN from v3):
#   - IGNORE_UNKNOWN_THING_REGIONS: False (reverted — True causes massive pixel
#     dropout with k=100 + threshold=0.01, losing ~50% of semantic signal)
#   - THING_STUFF_THRESHOLD: 0.05 (raised from 0.01 to reduce false thing clusters)
#   - Full resolution jitter (11 scales, matching CUPS default)
#   - NUM_STEPS_STARTUP: 500 (CUPS default)
#   - VAL_EVERY_N_STEPS: 200 (CUPS default)
#   - PRECISION: 16-mixed (bf16 requires Ampere+; use fp16 for Pascal/Turing GPUs)
#   - STEPS: 8000 (previous best PQ peaked at step 6500)
#
# Usage:
#   python refs/cups/train.py \
#       --experiment_config_file refs/cups/configs/train_cityscapes_resnet50_k100.yaml \
#       --disable_wandb
DATA:
  CROP_RESOLUTION: (640, 1280)
  SCALE: 0.625
  DATASET: "cityscapes"
  # REVERTED to False. With k=100 + threshold=0.05, too many thing clusters
  # still have sparse instance coverage → IGNORE=True drops huge pixel counts.
  # CUPS uses True with k=27 where thing/stuff split is clean. Our k=100
  # overclustering makes the split noisy → False is safer.
  IGNORE_UNKNOWN_THING_REGIONS: False
  # Raised from 0.01 to 0.05: reduces false-positive thing clusters.
  # With k=100, genuine thing clusters should have scores >> 0.05.
  # Stuff clusters with stray instance overlaps (~1-3%) get filtered out.
  THING_STUFF_THRESHOLD: 0.05
  ROOT: "datasets/cityscapes/"
  ROOT_VAL: "datasets/cityscapes/"
  ROOT_PSEUDO: "datasets/cityscapes/cups_pseudo_labels_k100/"
MODEL:
  BACKBONE_TYPE: "resnet50"
  USE_DINO: True
AUGMENTATION:
  NUM_STEPS_STARTUP: 500
  COPY_PASTE: True
  MAX_NUM_PASTED_OBJECTS: 8
  # CUPS default: 11 resolutions from 384 to 704.
  RESOLUTIONS:
    - [384, 768]
    - [416, 832]
    - [448, 896]
    - [480, 960]
    - [512, 1024]
    - [544, 1088]
    - [576, 1152]
    - [640, 1280]
    - [672, 1344]
    - [704, 1408]
SYSTEM:
  ACCELERATOR: "gpu"
  NUM_GPUS: 1
  NUM_WORKERS: 4
  LOG_PATH: "experiments"
  RUN_NAME: "cups_resnet50_k100_v4_stage2"
TRAINING:
  STEPS: 8000
  BATCH_SIZE: 16
  # Use fp16 for GTX 1080 Ti / RTX 20xx. Use bf16-mixed only on Ampere+ (A100, A6000, RTX 30xx+).
  PRECISION: "16-mixed"
  OPTIMIZER: "adamw"
  ADAMW:
    LEARNING_RATE: 0.0001
    WEIGHT_DECAY: 0.00001
  VAL_EVERY_N_STEPS: 200
  ACCUMULATE_GRAD_BATCHES: 1
  DROP_LOSS: True
  DROP_LOSS_IOU_THRESHOLD: 0.4
VALIDATION:
  CACHE_DEVICE: "cpu"
