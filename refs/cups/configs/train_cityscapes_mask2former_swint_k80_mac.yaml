# Stage-2 training: Mask2Former Swin-Tiny on Mac MPS
# Pseudo-labels: k=80 overclustered CAUSE + CC instances
# Hardware: Apple M4 Pro 48GB unified memory
#
# Key differences from GPU config:
#   - accelerator: mps (Apple Silicon)
#   - precision: 32-true (MPS has limited bf16/fp16 support)
#   - batch_size: 2 (conservative for 48GB unified memory)
#   - num_workers: 2 (MPS can have issues with multiprocess DataLoader)
#
# Usage:
#   cd unsupervised-panoptic-segmentation
#   PYTHONPATH=refs/cups:$PYTHONPATH python refs/cups/train.py \
#       --experiment_config_file refs/cups/configs/train_cityscapes_mask2former_swint_k80_mac.yaml \
#       --disable_wandb
DATA:
  CROP_RESOLUTION: (640, 1280)
  SCALE: 0.625
  DATASET: "cityscapes"
  IGNORE_UNKNOWN_THING_REGIONS: True
  THING_STUFF_THRESHOLD: 0.01
  ROOT: "/Users/qbit-glitch/Desktop/datasets/cityscapes/"
  ROOT_VAL: "/Users/qbit-glitch/Desktop/datasets/cityscapes/"
  ROOT_PSEUDO: "/Users/qbit-glitch/Desktop/datasets/cityscapes/cups_pseudo_labels_k80_train/"
MODEL:
  BACKBONE_TYPE: "mask2former_swinl"
  INFERENCE_CONFIDENCE_THRESHOLD: 0.5
  MASK2FORMER:
    PRETRAINED: "weights/mask2former-swin-tiny-coco-panoptic"
    NUM_QUERIES: 100
    BACKBONE_LR_MULTIPLIER: 0.0
    WEIGHT_DECAY: 0.05
    NO_OBJECT_WEIGHT: 0.1
    CLASS_EMBED_LR_MULTIPLIER: 10.0
AUGMENTATION:
  NUM_STEPS_STARTUP: 500
  COPY_PASTE: True
  MAX_NUM_PASTED_OBJECTS: 8
  RESOLUTIONS:
    - [384, 768]
    - [416, 832]
    - [448, 896]
    - [480, 960]
    - [512, 1024]
    - [544, 1088]
    - [576, 1152]
    - [640, 1280]
    - [672, 1344]
    - [704, 1408]
SYSTEM:
  ACCELERATOR: "mps"
  NUM_GPUS: 1
  NUM_WORKERS: 2
  LOG_PATH: "experiments"
  RUN_NAME: "cups_mask2former_swint_k80_mac"
TRAINING:
  STEPS: 4000
  BATCH_SIZE: 2
  ACCUMULATE_GRAD_BATCHES: 8
  PRECISION: "32-true"
  OPTIMIZER: "adamw"
  ADAMW:
    LEARNING_RATE: 0.0001
    WEIGHT_DECAY: 0.05
  GRADIENT_CLIP_ALGORITHM: "norm"
  GRADIENT_CLIP_VAL: 0.01
  VAL_EVERY_N_STEPS: 200
  DROP_LOSS: False
  DROP_LOSS_IOU_THRESHOLD: 0.4
VALIDATION:
  CACHE_DEVICE: "cpu"
